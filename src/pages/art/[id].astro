---
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/Button.astro";
import appleIcon from "../../assets/apple-icon.svg?raw";
import basaltFavicon from "../../assets/basalt-icon-tr.svg?raw";

interface Wallpaper {
    id: string;
    url: string;
    name: string;
    description: string;
    artist: string;
    creationDate: string;
    dominantColors: string[];
}

const { id } = Astro.params;
let wallpaper: Wallpaper | null = null;
let error = false;

try {
    const response = await fetch(
        "https://basalt-prod.up.railway.app/api/wallpapers",
    );
    if (response.ok) {
        const allWallpapers: Wallpaper[] = await response.json();
        wallpaper = allWallpapers.find((w) => w.id === id) || null;
    } else {
        error = true;
    }
} catch (e) {
    error = true;
    console.error("Failed to fetch wallpaper:", e);
}

if (!wallpaper) {
    return Astro.redirect("/404");
}

const displayData = wallpaper;

const imageBg =
    displayData.dominantColors && displayData.dominantColors.length > 0
        ? displayData.dominantColors[0]
        : "#E6E3DF"; // Fallback to a stone-like hex

// --- Hex to OKLCH Helpers ---
import { hexToOklch } from "../../utils/color";

// Convert
const [L, C, h] = hexToOklch(imageBg);

// Dynamic CSS Variables
const dynamicH = h.toFixed(2);
const dynamicC = C.toFixed(4);
---

<Layout
    title={`Basalt Wallpaper: ${displayData.name}`}
    backgroundColor="var(--bg-dynamic)"
    footerSpan="2-5"
>
    <Fragment
        set:html={`<style>
    :root[data-theme="dark"] {
      --bg-dynamic: oklch(0.2 0.05 ${dynamicH}) !important;
    }
  </style>`}
    />
    <!-- Hero Section (Outside Grid, Max 1248px) -->
    <div class="hero-wrapper">
        {
            displayData.url ? (
                <img
                    src={displayData.url}
                    alt={displayData.name}
                    class="hero-img"
                />
            ) : (
                <div class="placeholder-image">
                    <span>Art Placeholder</span>
                </div>
            )
        }
    </div>

    <r-grid
        class="main content-grid page-grid"
        columns="6"
        columns-s="4"
        columns-xs="1"
    >
        <!-- Content Section -->
        <r-cell span="2-5" span-s="row" span-xs="row" class="content">
            <!-- Label -->
            <div class="label">
                <div class="icon-b">
                    <Fragment set:html={basaltFavicon} />
                </div>
                <span
                    class="text-small"
                    style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;"
                    >Basalt Art</span
                >
            </div>

            <!-- Typography -->
            <h1>{displayData.name}</h1>
            <h3
                style="font-weight: 500; font-family: var(--font-sans); color: var(--text-secondary); margin-top: 0.5rem; margin-bottom: 2rem;"
            >
                {displayData.artist}, {displayData.creationDate}
            </h3>

            <p class="text-medium" style="margin-bottom: 10rem;">
                {displayData.description}
            </p>

            <!-- Action Base -->
            <div>
                <Button
                    href="https://apps.apple.com/us/app/basalt-curated-wallpapers/id6757328187?mt=12"
                    target="_blank"
                >
                    <Fragment set:html={appleIcon} />
                    Download Basalt for Mac
                </Button>
            </div>
        </r-cell>
    </r-grid>
</Layout>

<style define:vars={{ imageBg }}>
    /* Image stays independent of the grid's padding constraints */
    .hero-wrapper {
        width: 100%;
        max-width: 1248px;
        margin: 0 auto;

        display: flex;
        justify-content: center;
        align-items: center;
    }

    .hero-img {
        width: auto;
        height: auto;
        max-width: 100%;
        max-height: min(860px, calc(100vh - 200px));
        object-fit: contain;
        display: block;
        /* background-color: var(--imageBg); Remove background from image itself to let page bg show through padding */
    }

    /* Override grid top padding to bring text closer to image */
    .content-grid {
        padding-top: 4rem;
    }

    .placeholder-image {
        width: 100%;
        height: 100%;
        background-color: var(--imageBg);
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--text-secondary);
        font-size: var(--fs-h3);
        border-radius: 4px;
    }

    .label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
    }

    .icon-b {
        width: 24px;
        height: 24px;
    }

    .icon-b :global(svg) {
        width: 100%;
        height: 100%;
    }
</style>

<script>
    import mediumZoom from "medium-zoom";

    mediumZoom(".hero-img", {
        margin: 24,
        background: "var(--bg-primary)", // Use primary background for zoom overlay
        scrollOffset: 0,
    });
</script>
